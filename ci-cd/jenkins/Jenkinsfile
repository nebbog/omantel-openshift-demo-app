pipeline {
  agent {
    kubernetes {
      yaml '''
        apiVersion: v1
        kind: Pod
        spec:
          serviceAccountName: jenkins-agent
          containers:
          - name: builder
            image: localhost:30100/builder:1.2.0
            command:
            - cat
            tty: true
            securityContext:
              seccompProfile:
                type: RuntimeDefault
              runAsNonRoot: true
              runAsUser: 1000
              runAsGroup: 1000
          - name: docker
            image: localhost:30100/dockerbash:1.8.0
            command:
            - cat
            tty: true
            volumeMounts:
             - mountPath: /var/run/docker.sock
               name: docker-sock
          volumes:
          - name: docker-sock
            hostPath:
              path: /var/run/docker.sock    
        '''
    }
  }
  stages {
 
   stage('Build Java project - demo-app') {
     steps{
       container('builder') {
         withCredentials([usernamePassword(credentialsId: 'omantel-git-user', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')]) {
           script {
             sh 'git remote set-url origin http://${GIT_USERNAME}:"${GIT_PASSWORD}"@gitlab.lab.local/nebbog/omantel-demo-app.git'
             sh 'git config --global credential.helper cache'
             sh 'git config --global user.email "gituser@lab.local"'
             sh 'git config --global user.name "Omantel git user"'
             sh 'pwd;ls -lrth'
             sh 'cd ci-cd;./build.sh -i \${INFRASTRUCTURE} -e \${ENVIRONMENT} -b \${BRANCH}'
           }
         }
       }
     }
   }

   stage('Build demo-app tomcat image') {
     steps{
       container('docker') {
         script {
           sh 'cd ci-cd/docker;./make-image.sh'
         }
       }
     }
   }

   stage('Pushing demo-app tomcat Image') {
     steps{
       container('docker') {
         script {
             sh 'cd ci-cd/docker;./push-image-to-docker-registry.sh'
         }
       }
     }
   }
   
    stage('Deploying to minikube cluster') {
     steps{
       container('docker') {
         script {
            sh 'curl -LO "https://storage.googleapis.com/kubernetes-release/release/v1.30.2/bin/linux/amd64/kubectl"'
            sh 'chmod a+x ./kubectl;cp ./kubectl /tmp'
            sh 'curl -LO https://get.helm.sh/helm-v3.15.3-linux-amd64.tar.gz'
            sh 'tar -zxvf helm-v3.15.3-linux-amd64.tar.gz;cp linux-amd64/helm /tmp'
            sh 'kubectl version;helm version'
            sh 'cd ci-cd/k8s;./deploy.sh -i \${INFRASTRUCTURE} -e \${ENVIRONMENT}'
         }
       }
     }
   }

 }
}
